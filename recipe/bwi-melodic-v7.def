BootStrap: docker
From: tacc/tacc-ubuntu18-mvapich2.3-ib:latest

%labels

%help
    c303-005.ls6(1008)$ ibrun singularity run containers/bwi-melodic-v5.simg osu_bcast
    TACC:  Starting up job 1098372
    TACC:  Starting parallel tasks...
    Warning: Process to core binding is enabled and OMP_NUM_THREADS is set to non-zero (1) value
    If your program has OpenMP sections, this can cause over-subscription of cores and consequently poor performance
    To avoid this, please re-run your application after setting MV2_ENABLE_AFFINITY=0
    Use MV2_USE_THREAD_WARNING=0 to suppress this message

    # OSU MPI Broadcast Latency Test v5.6
    # Size       Avg Latency(us)
    1                      31.06
    2                       9.24
    4                       9.38
    8                       9.54
    16                      9.59
    32                      9.54
    64                      9.85
    128                     9.83
    256                    10.20
    512                    10.48
    1024                   11.58
    2048                   14.83
    4096                   20.20
    8192                   21.48
    16384                  31.14
    32768                  51.19
    65536                  91.46
    131072                182.98
    262144                358.61
    524288                546.26
    1048576               698.93
    TACC:  Shutdown complete. Exiting.

    Additional issue:
    When source /bwi_ws/devel/setup.bash, following error occur.
        Could not create temporary file:
        /bwi_ws/devel/setup.sh: line 24: uname: command not found
        /bwi_ws/devel/setup.sh: line 55: mktemp: command not found
%files

%post
    export ROS_DISTRO=melodic
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y gnupg apt-utils curl nano vim tmux python-pip
    echo 'deb http://packages.ros.org/ros/ubuntu bionic main' > /etc/apt/sources.list.d/ros-latest.list
    curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add -

    apt-get update
    apt-get install -y ros-${ROS_DISTRO}-desktop-full python-rosdep python-rosinstall python-rosinstall-generator \
                       python-wstool build-essential python-catkin-tools libqt5websockets5-dev qt5-default psmisc
    pip install -U pyYAML
    rosdep init

    ####################################
    # Install bwi repositories (light) #
    ####################################
    # dependencies
    apt-get install -y ros-melodic-actionlib-tutorials ros-melodic-cv-bridge ros-melodic-map-server ros-melodic-gazebo-ros \
                       ros-melodic-gazebo-msgs ros-melodic-gazebo-ros-control ros-melodic-gazebo-plugins ros-melodic-pcl-ros \
                       ros-melodic-robot-state-publisher ros-melodic-joint-state-publisher ros-melodic-joint-trajectory-controller \
                       ros-melodic-dynamic-reconfigure ros-melodic-message-filters ros-melodic-map-msgs ros-melodic-xacro \
                       ros-melodic-laser-filters ros-melodic-nodelet ros-melodic-pluginlib ros-melodic-roslint ros-melodic-move-base \
                       ros-melodic-move-base-msgs ros-melodic-amcl ros-melodic-nav-msgs ros-melodic-depthimage-to-laserscan \
                       ros-melodic-pointcloud-to-laserscan ros-melodic-pr2-description ros-melodic-dwa-local-planner \
                       ros-melodic-eband-local-planner ros-melodic-global-planner ros-melodic-rviz ros-melodic-octomap
    # Download BWI repo
    mkdir -p /bwi_ws/src && cd /bwi_ws/src
    git clone -b jinsoo/light-hal-sim https://github.com/utexas-bwi/bwi.git
    git clone -b jinsoo/light-hal-sim https://github.com/utexas-bwi/bwi_common.git
    git clone -b jinsoo/light-hal-sim https://github.com/utexas-bwi/segbot.git
    git clone -b main https://github.com/utexas-bwi/segbot_bringup.git
    git clone -b master https://github.com/marinaKollmitz/gazebo_ros_2Dmap_plugin

    # Compile BWI repo
    cd /bwi_ws
    catkin config --init
    bash -c "source /opt/ros/melodic/setup.bash; catkin build -j6"  # Use -j2 if machine is slow

    # Install Dynamic-PHHP dependencies
    apt-get install -y python3-pip
    pip3 install torch numpy pyYAML rospkg netifaces mpi4py

%environment
    # fix locale::facet::_5_create_c_locale name not valid error
    export LANG="C"
    export LC_ALL="C"

    # ros
    export ROS_HOSTNAME=localhost
    export ROS_MASTER_URI=http://localhost:11311